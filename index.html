<!DOCTYPE html>
<html>
  <head>
    <title>Live Transcription</title>
  </head>
  <body>
    <h1>üéôÔ∏è Speak now</h1>
    <pre id="transcript"></pre>

    <script>
      const transcript = document.getElementById("transcript");
      const ws = new WebSocket("ws://localhost:8000/ws");

      ws.onmessage = (event) => {
        transcript.textContent += event.data + "\n";
      };

      async function start() {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        const context = new AudioContext({ sampleRate: 16000 }); // Amazon requires 16kHz
        const source = context.createMediaStreamSource(stream);
        const processor = context.createScriptProcessor(4096, 1, 1);

        source.connect(processor);
        processor.connect(context.destination);

        processor.onaudioprocess = function (e) {
          const input = e.inputBuffer.getChannelData(0); // Float32 [-1.0, 1.0]
          const pcm = new Int16Array(input.length);

          for (let i = 0; i < input.length; i++) {
            let s = Math.max(-1, Math.min(1, input[i]));
            pcm[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
          }

          if (ws.readyState === WebSocket.OPEN) {
            ws.send(pcm.buffer); // send as binary
          }
        };
      }

      start();
    </script>
  </body>
</html>
